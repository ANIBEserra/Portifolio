name: Credit Guard - Docker & Airflow Infrastructure (Bi-weekly)

on:
  schedule:
    # Runs at 11:50 UTC (08:50 BRT) on the 1st and 15th of each month
    - cron: '50 11 1,15 * *'
  workflow_dispatch: # Allows manual triggering for testing purposes

jobs:
  infrastructure-orchestration:
    name: Run Airflow Orchestration inside Docker
    runs-on: ubuntu-latest

    steps:
      # 1. Clone the repository into the runner
      - name: Checkout Repository
        uses: actions/checkout@v4

      # 2. Set up the GCP credentials file for the container environment
      - name: Setup GCP Credentials
        env:
          GCP_KEY_JSON: ${{ secrets.GCP_SA_KEY }}
        run: |
          # Ensuring the key is placed where the Docker volume mapping expects it
          echo "$GCP_KEY_JSON" > projetos/data_engineering/credit_guard_ml_pipeline/key-google.json

      # 3. Spin up the full Docker Compose stack (Postgres, Scheduler, Webserver, Worker)
      - name: Spin up Docker Compose
        env:
          # GitHub Actions takes Secret and puts it in a variable that Docker Compose reads
          GCP_SA_KEY: ${{ secrets.GCP_SA_KEY }} 
        run: |
          cd projetos/data_engineering/credit_guard_ml_pipeline
          docker-compose up -d
          echo "Waiting for Airflow..."
          sleep 120

      # 4. Trigger the specific DAG inside the running Scheduler container
      - name: Trigger Airflow DAG
        run: |
          # Finds the exact container name for the scheduler
          SCHEDULER_CONTAINER=$(docker ps --format "{{.Names}}" | grep airflow-scheduler)
          echo "Targeting container: $SCHEDULER_CONTAINER"
          
          # Triggers the DAG
          docker exec $SCHEDULER_CONTAINER airflow dags trigger pipeline_ingestao_cnpj
          
          echo "DAG triggered successfully! Waiting for execution..."
          sleep 60
          
          # Since you are using LocalExecutor, the logs are in the scheduler container
          docker logs $SCHEDULER_CONTAINER --tail 50

      # 5. Clean up the environment to free up runner resources
      - name: Shutdown Infrastructure
        if: always() # Ensures cleanup even if previous steps fail
        run: |
          cd projetos/data_engineering/credit_guard_ml_pipeline
          docker-compose down